## 模块设计

#### **1. generateExam 方法**

`generateExam` 方法的核心功能是根据传入的知识点 ID 列表，自动生成一份试卷，并将试卷信息存储在 Neo4j 数据库中。

- **功能描述**：根据传入的知识点 ID 列表，生成试卷标题，并从数据库中为每个知识点选取最多 5 道题目。生成的试卷包含题目内容、标准答案、题目类型等信息，最终保存到数据库，并返回生成的试卷信息。
- **参数**：
  - `JSONArray knowledgeIds`: 包含多个知识点 ID 的数组。
  - `String username`: 当前用户的用户名。
- **返回值**：
  - `JSONObject`: 返回包含试卷 ID、标题、题目列表及题目 ID 列表的 JSON 对象。
- **实现过程**：
  1. **生成试卷标题**：根据传入的知识点名称构建试卷标题。
  2. **从数据库获取题目**：使用 `ExerciseRepository` 获取每个知识点下的题目列表。
  3. **去重并生成试卷**：避免重复题目，通过集合 `usedQuestionIds` 确保每个题目只添加一次。
  4. **存储试卷数据**：将生成的试卷信息存储到 Neo4j 数据库。

#### **2. saveExam 方法**

`saveExam` 方法用于保存已生成的试卷，标记试卷为已保存状态。方法会更新试卷节点的 `flag` 属性，表明试卷已完成保存。

- **功能描述**：通过试卷 ID 找到对应的试卷并将其标记为已保存，同时清理数据库中未保存的试卷。
- **参数**：
  - `String examId`: 试卷的唯一标识符。
- **返回值**：
  - `JSONObject`: 返回保存结果，包含试卷 ID 和标题。

#### **3. getExam 方法**

`getExam` 方法用于根据试卷 ID 和用户名查询试卷信息。该方法支持根据试卷 ID 查询特定试卷信息，也支持查询某个用户的所有试卷。

- **功能描述**：根据试卷 ID 或用户名查询对应的试卷信息，包括题目列表和试卷 ID。
- **参数**：
  - `String examId`: 试卷 ID，若为空则查询所有试卷。
  - `String username`: 用户名。
- **返回值**：
  - `JSONArray`: 返回试卷列表，包括试卷 ID、标题和题目列表等信息。

#### **4. submitExam 方法**

`submitExam` 方法用于处理学生提交的试卷答案，并将用户答案与试卷进行关联。

- **功能描述**：将学生的作答数据保存到数据库中，并将其与试卷节点关联。
- **参数**：
  - `String examId`: 试卷 ID。
  - `JSONArray answers`: 学生提交的答案列表。
  - `String username`: 用户名。
- **返回值**：
  - `boolean`: 返回是否提交成功。

## 系统工作流程

### **1. 试卷生成流程**

#### **1.1 输入参数：**

- **知识点 ID 列表**：学生或系统传入的一组知识点 ID，决定试卷中包含哪些知识点。
- **用户名**：当前用户（教师或管理员）用来生成试卷的身份标识。

#### **1.2 试卷生成步骤：**

1. **接收请求**：当系统收到请求时，前端将一组知识点 ID 和用户名通过 API 发送给后端。
2. **构建试卷标题**：系统根据传入的知识点 ID 列表生成试卷标题。标题包括这些知识点的名称，并在需要时附加“等”字以指示其他相关内容。
   - 例如：如果传入了 "知识点1"、"知识点2" 和 "知识点3"，则生成的试卷标题为："知识点1, 知识点2, 等 - 2024-12-03 10:00:00"。
3. **从数据库中获取题目**：后端通过调用 `ExerciseRepository` 类的相关方法，从 Neo4j 数据库中根据每个知识点 ID 获取最多 5 道题目。系统确保题目不重复。
4. **生成试卷内容**：根据查询到的题目，构建试卷的 JSON 格式数据结构，包含每道题的内容、标准答案和题目类型（例如选择题、简答题等）。
5. **存储试卷数据**：系统将生成的试卷信息（包括试卷 ID、标题、题目列表、题目 ID 列表等）存入 Neo4j 图数据库。创建一个名为 `试卷` 的节点，其中包含试卷的详细信息。
6. **返回生成的试卷信息**：生成的试卷信息将通过 API 返回给前端，前端可展示生成的试卷标题、题目列表等内容。此时，试卷状态标记为“未保存”，尚未正式提交。

------

#### **1.3 试卷生成相关数据结构：**

- 试卷节点 (exam)
  - **examId**: 试卷的唯一标识符。
  - **examTitle**: 试卷标题。
  - **quesList**: 包含试题内容的 JSON 数组。
  - **quesIds**: 包含所有题目 ID 的 JSON 数组。

#### **1.4 示例流程：**

1. 用户（教师）通过前端页面选择要生成的知识点。
2. 前端将知识点 ID 列表传递给后端。
3. 后端根据这些知识点从数据库中检索相关题目并生成试卷。
4. 系统保存生成的试卷数据并返回给前端。

------

### **2. 用户作答流程**

#### **2.1 输入参数：**

- **考试 ID**：用户（学生）要作答的试卷 ID。
- **答案列表**：学生对试卷中每道题目的回答。

#### **2.2 用户作答步骤：**

1. **学生提交答案**：学生在前端页面填写试卷答案，并点击提交按钮。学生提交的答案包括题目 ID 和对应的回答内容。
2. **接收提交请求**：前端通过 API 将学生提交的答案发送到后端，包含试卷 ID 和每道题目的答案。
3. **保存用户作答数据**：
   - 系统为每个学生的作答生成一个唯一的作答 ID。
   - 将学生的作答数据（包括每道题目的答案）保存到 Neo4j 数据库。作答数据通过 `用户作答` 节点存储，并与试卷节点建立关系（`answer_relation`）。
4. **与试卷关联**：系统将学生的作答与相应的试卷进行关联。通过创建 `answer_relation` 关系，将 `用户作答` 节点与对应的 `试卷` 节点关联起来。
5. **返回提交结果**：提交成功后，系统返回一个成功的响应，通知前端学生的作答已成功提交。
6. **后端批改（可选）**：如果有配置大模型批改功能，后端会调用 AI 模型接口对学生的作答进行批改，并生成批改结果（包括每道题的得分和反馈）。批改结果会与用户作答节点进行关联。

------

#### **2.3 用户作答相关数据结构：**

- **用户作答节点** (`user_answer`):
  - **userAnswerId**: 用户作答的唯一标识符。
  - **answers**: 包含题目 ID 和学生答案的 JSON 数组。
  - **username**: 用户名，表示是谁提交的答案。
- **关系** (`answer_relation`):
  - 该关系用于连接 `用户作答` 节点与 `试卷` 节点，表明该学生作答的是哪一份试卷。

#### **2.4 示例流程：**

1. 学生在前端页面填写答案并点击提交。
2. 系统接收学生提交的答案，生成一个唯一的作答 ID。
3. 系统将答案保存到数据库，并将作答数据与试卷进行关联。
4. 系统返回提交成功的响应给前端。

------

### **3. 完整的工作流程总结**

1. **生成试卷**：
   - 教师选择知识点，系统根据知识点生成试卷，并存储到 Neo4j 数据库。
   - 系统返回试卷信息给前端，供学生查看。
2. **提交试卷**：
   - 学生填写试卷答案并提交，系统保存答案并与试卷进行关联。
   - 后端可以通过大模型对答案进行批改，并返回批改结果。
3. **结果查询和复核**：
   - 教师可以复核试卷批改结果，修改得分或反馈。
   - 学生可以查询自己的批改结果，查看每道题的得分和详细反馈。

此工作流程确保了从试卷生成到用户作答、批改、复核的各个环节都能够高效、准确地进行管理。系统通过与 Neo4j 图数据库的深度集成，能够处理复杂的数据关联和查询，为用户提供稳定的服务。





## 接口设计

### 1. **GET /api/knowledge/exercises**

#### 请求参数：

```typescript
export interface Request {
    /**
     * 知识点 ID 编号（可选）
     */
    id?: string;
    [property: string]: any;
}
```

#### 返回响应：

```typescript
export interface Response {
    /**
     * http状态码，200为成功，其他为不成功
     */
    code: number;

    /**
     * 题目列表
     */
    quesList: QuesList[];

    /**
     * 成功与否，状态
     */
    success: boolean;

    [property: string]: any;
}

export interface QuesList {
    /**
     * 标准答案
     */
    standardAnswer: string;

    /**
     * 题目内容
     */
    titleContent: string;

    [property: string]: any;
}
```

#### 功能描述：

- 获取知识点相关的题目列表。可以通过 `id` 参数筛选特定知识点的题目。

------

### 2. **POST /api/exam/generate**

#### 请求参数：

```typescript
export interface Request {
    /**
     * 要包含的知识点ID列表
     */
    knowledgeIds: string[];

    /**
     * 用户名
     */
    username: string;

    [property: string]: any;
}
```

#### 返回响应：

```typescript
export interface Response {
    /**
     * http状态码，200为成功，其他为不成功
     */
    code: string;

    /**
     * 试卷ID
     */
    examId: string;

    /**
     * 试卷标题
     */
    examTitle: string;

    /**
     * 题目列表
     */
    quesList: QuesList[];

    /**
     * 成功与否，true为成功，false为不成功
     */
    success: string;

    [property: string]: any;
}

export interface QuesList {
    /**
     * 标准答案
     */
    standardAnswer: string;

    /**
     * 题目内容
     */
    titleContent: string;

    [property: string]: any;
}
```

#### 功能描述：

- 用户通过传递知识点 ID 列表生成包含相关习题的试卷。

------

### 3. **GET /api/exam/save**

#### 请求参数：

```typescript
export interface Request {
    /**
     * 试卷ID（可选）
     */
    id?: string;

    [property: string]: any;
}
```

#### 返回响应：

```typescript
export interface Response {
    /**
     * http状态码，200为成功，其他为不成功
     */
    code: string;

    /**
     * 试卷ID
     */
    examId: string;

    /**
     * 试卷标题
     */
    examTitle: string;

    /**
     * 题目列表
     */
    quesList: QuesList[];

    /**
     * 成功与否，true为成功，false为不成功
     */
    success: string;

    [property: string]: any;
}

export interface QuesList {
    /**
     * 标准答案
     */
    standardAnswer: string;

    /**
     * 题目内容
     */
    titleContent: string;

    [property: string]: any;
}
```

#### 功能描述：

- 保存试卷数据，完成试卷保存后的状态标记。

------

### 4. **POST /api/exam/submit**

#### 请求参数：

```typescript
export interface Request {
    /**
     * 用户答案列表
     */
    answers: string[];

    /**
     * 试卷ID
     */
    examId: string;

    /**
     * 用户名
     */
    username: string;
}
```

#### 返回响应：

```typescript
export interface Response {
    /**
     * http状态码，200为成功，其他为不成功
     */
    code: number;

    [property: string]: any;
}
```

#### 功能描述：

- 提交用户的试卷答案，并关联到试卷数据。

------

### 5. **GET /api/exam/getExam**

#### 请求参数：

```typescript
export interface Request {
    /**
     * 试卷ID（可选）
     */
    examId?: string;

    /**
     * 用户名（可选）
     */
    username?: string;

    [property: string]: any;
}
```

#### 返回响应：

```typescript
export interface Response {
    /**
     * http状态码，200为成功，其他为不成功
     */
    code: string;

    /**
     * 试卷ID
     */
    examId: string;

    /**
     * 试卷标题
     */
    examTitle: string;

    /**
     * 题目id列表
     */
    quesIds: string[];

    /**
     * 题目详细列表
     */
    quesList: QuesList[];

    /**
     * 成功与否，true为成功，false为不成功
     */
    success: string;

    [property: string]: any;
}

export interface QuesList {
    /**
     * 标准答案
     */
    standardAnswer: string;

    /**
     * 题目内容
     */
    titleContent: string;

    /**
     * 题目类型
     */
    type: string;

    [property: string]: any;
}
```

#### 功能描述：

- 获取试卷内容，包括试卷的标题、题目列表和题目 ID 列表。

------

### 6. **GET /api/exam/getAnswer**

#### 请求参数：

```typescript
export interface Request {
    /**
     * 试卷ID（可选）
     */
    examId?: string;

    /**
     * 用户名（可选）
     */
    username?: string;

    [property: string]: any;
}
```

#### 返回响应：

```typescript
export interface Response {
    /**
     * http状态码，200为成功，其他为不成功
     */
    code: number;

    /**
     * 用户作答数据
     */
    userAnswers: UserAnswer[];

    [property: string]: any;
}

export interface UserAnswer {
    /**
     * 答案列表
     */
    answers: string[];

    /**
     * 用户作答 ID
     */
    id: string;
}
```

#### 功能描述：

- 获取用户作答数据，返回用户的作答答案。

------

### 7. **DELETE /api/exam/del**

#### 请求参数：

```typescript
export interface Request {
    /**
     * 试卷ID
     */
    examId: string;

    [property: string]: any;
}
```

#### 返回响应：

```typescript
export interface Response {
    /**
     * http状态码，200为成功，其他为不成功
     */
    code: string;

    [property: string]: any;
}
```

#### 功能描述：

- 删除指定 ID 的试卷，删除操作会移除相关节点及其关系。





## 质量保证（QA）过程：试卷生成与用户作答

#### 测试策略：

为了确保试卷生成与用户作答模块的可靠性、稳定性以及用户满意度，我们实施了全面的多层次测试策略。此策略涵盖了单元测试、模块测试、前后端联调测试、系统测试及交付测试，确保每个模块和功能在实际环境中能够顺利运行。以下是基于试卷生成与用户作答功能的具体测试内容和执行策略：

------

##### 1. **单元测试（基础逻辑、函数等）**

单元测试是对系统中最小功能单元（如函数和方法）进行的独立测试，确保每个功能的基本逻辑正确性。我们通过单元测试验证核心数据处理类的功能，并确保在单一功能模块下没有潜在的逻辑错误。

**测试内容：**

- **ExamService** 类：
  - 测试 `generateExam` 方法，确保根据知识点生成的试卷包含正确的题目和知识点。
  - 测试 `saveExam` 方法，确保保存试卷时，试卷的题目和相关数据能够正确更新，并且在数据库中标记为已保存。
- **提交与作答相关方法**：
  - 测试 `submitExam` 方法，确保提交的答案能够正确关联到用户，并且能够正确存储到数据库中。
  - 测试 `getAnswersByExamId` 方法，确保用户提交的答案能够通过试卷 ID 和用户名进行准确查询。
  - 测试 `deleteExam` 方法，确保删除试卷操作能够在数据库中成功执行。
- **数据模型测试**：
  - 确保 `Exam` 类、`UserAnswer` 类和其他数据结构能够正确地映射到数据库中的记录，并能够正确处理存储和查询。

**示例测试：**

- 测试 `generateExam` 方法是否能根据传入的知识点 ID 正确生成试卷，并包含指定数量的题目。
- 测试 `submitExam` 方法是否能成功将用户提交的答案存储并与试卷关联。

------

##### 2. **模块测试（每个接口、页面）**

模块测试验证每个独立模块和功能是否能够按照预期工作，确保不同部分的业务逻辑实现无误。通过模拟用户请求，测试试卷生成、用户作答提交和试卷查询等接口的功能。

**测试内容：**

- **试卷生成接口**：
  - 测试 `POST /api/exam/generate` 接口，确保传入知识点 ID 列表后，生成的试卷包含正确的题目，并且返回的试卷 ID 和标题符合预期。
- **试卷保存接口**：
  - 测试 `GET /api/exam/save` 接口，确保保存试卷后，数据库中保存的试卷状态正确更新。
- **用户作答提交接口**：
  - 测试 `POST /api/exam/submit` 接口，确保用户提交的答案能够正确与试卷进行关联，并且答案能够正确存储。
- **试卷内容获取接口**：
  - 测试 `GET /api/exam/getExam` 接口，确保通过传入的试卷 ID 和用户名能够获取到正确的试卷内容和题目列表。

**示例测试：**

- 测试 `generateExam` 方法生成试卷后，调用 `saveExam` 接口是否能够成功保存该试卷。
- 测试 `submitExam` 接口是否能够正确保存用户的作答并返回状态。

------

##### 3. **前后端联调测试（每个页面和对应的接口）**

前后端联调测试确保前端页面能够正确调用后端接口，并且数据交互顺畅，UI呈现的数据准确无误。确保用户从试卷生成、作答提交到查看试卷结果的整个过程能够顺利执行。

**测试内容：**

- **试卷生成页面**：
  - 模拟用户选择多个知识点并点击“生成试卷”按钮，前端通过调用 `/api/exam/generate` 接口生成试卷。
  - 测试生成后的试卷是否正确展示在页面上，题目是否完整。
- **用户作答提交页面**：
  - 测试学生在提交试卷时，是否能够将用户的答案成功提交到 `/api/exam/submit` 接口，并且返回正确的批改结果。
- **试卷批改结果页面**：
  - 测试学生提交试卷后，批改结果是否正确显示，得分和详细反馈信息是否完整。

**示例测试：**

- 模拟用户选择多个知识点并点击“生成试卷”按钮，前端调用接口生成试卷，检查返回的数据是否在页面上正确展示。
- 模拟学生提交作答，前端调用 `submitExam` 接口，检查后端返回的状态码和批改结果是否准确显示在页面上。

------

##### 4. **系统测试（整个软件）**

系统测试是对整个系统进行的全面测试，确保所有功能模块在实际环境中能够协调工作，并且能够高效地处理高并发请求。重点测试系统在不同场景下的功能实现、性能、兼容性和安全性。

**测试内容：**

- **功能完整性**：
  - 模拟用户操作，确保系统所有功能模块正常工作。包括试卷生成、题目获取、用户作答提交、批改结果查询和删除试卷等功能。
- **性能测试**：
  - 测试在高并发情况下，系统是否能够有效处理多个用户同时提交试卷并生成批改结果。重点测试接口的响应时间和系统稳定性。
- **数据一致性**：
  - 测试系统在试卷生成、用户作答和批改结果保存的过程中，是否能够确保数据的一致性和准确性。
- **安全性测试**：
  - 测试用户提交的数据是否得到正确的验证和保护，确保系统不会出现数据泄露或恶意攻击问题。

**示例测试：**

- **功能测试**：模拟学生在试卷生成、提交作答和查询批改结果的完整操作流程，确保功能完整性没有遗漏。
- **性能测试**：模拟上千用户同时提交试卷，确保系统能在负载较大的情况下快速响应并正确保存数据。